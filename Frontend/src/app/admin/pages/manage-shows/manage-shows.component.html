<div class="manage-shows-container">
  <div class="header">
    <h2>Manage Shows</h2>
    <button *ngIf="!showForm()" (click)="addShow()" class="btn-primary">+ Add Show</button>
  </div>

  <div *ngIf="loading()" class="loading">
    <div class="spinner"></div>
    <p>Loading shows...</p>
  </div>

  <div *ngIf="!showForm() && !loading()" class="shows-list">
    <div *ngIf="shows().length === 0" class="empty-state">
      <div class="empty-icon">üé¨</div>
      <h3>No Shows Found</h3>
      <p>Click "Add Show" to create your first show</p>
    </div>

    <table *ngIf="shows().length > 0">
      <thead>
        <tr>
          <th>Movie</th>
          <th>Theater</th>
          <th>Screen</th>
          <th>Show Time</th>
          <th>Price</th>
          <th>Seats</th>
          <th>Status</th>
          <th>Actions</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let show of shows()">
          <td>{{ show.movie?.title || 'N/A' }}</td>
          <td>{{ show.theater?.name || 'N/A' }}</td>
          <td>{{ show.screen }}</td>
          <td>{{ show.showDateTime | date:'short' }}</td>
          <td>‚Çπ{{ show.ticketPrice }}</td>
          <td>{{ show.availableSeats }}/{{ show.totalSeats }}</td>
          <td>
            <span class="status-badge" [class.active]="show.status === 'ACTIVE'">
              {{ show.status }}
            </span>
          </td>
          <td>
            <button (click)="editShow(show)" class="btn-edit" title="Edit">‚úèÔ∏è</button>
            <button (click)="deleteShow(show)" class="btn-delete" title="Delete">üóëÔ∏è</button>
          </td>
        </tr>
      </tbody>
    </table>
  </div>

  <div *ngIf="showForm()" class="show-form">
    <h3>{{ editingShowId() ? 'Edit Show' : 'Add New Show' }}</h3>
    
    <div class="form-section">
      <h4>Basic Information</h4>
      
      <div class="form-group">
        <label>Movie *</label>
        <select [(ngModel)]="selectedMovieId" required>
          <option value="">Select Movie</option>
          <option *ngFor="let movie of movies()" [value]="movie.id">
            {{ movie.title }} ({{ movie.duration }} min)
          </option>
        </select>
        <small *ngIf="movies().length === 0" class="hint">No movies available. Please add movies first.</small>
      </div>

      <div class="form-group">
        <label>Theater *</label>
        <select [(ngModel)]="selectedTheaterId" (change)="onTheatreChange()" required>
          <option value="">Select Theater</option>
          <option *ngFor="let theater of theaters()" [value]="theater.id">
            {{ theater.name }} - {{ theater.location }}
          </option>
        </select>
        <small *ngIf="theaters().length === 0" class="hint">No theaters available. Please add theaters first.</small>
      </div>

      <div class="form-group">
        <label>Screen *</label>
        <select [(ngModel)]="selectedScreenId" (change)="onScreenChange()" [disabled]="!selectedTheaterId" required>
          <option value="">Select Screen</option>
          <option *ngFor="let screen of screens()" [value]="screen.id">
            {{ screen.name }} ({{ screen.totalSeats }} seats)
          </option>
        </select>
        <small *ngIf="selectedTheaterId && screens().length === 0" class="hint">No screens available for this theater.</small>
      </div>

      <div class="form-group">
        <label>Show Date & Time *</label>
        <input type="datetime-local" [(ngModel)]="showDateTime" required>
      </div>
    </div>

    <div *ngIf="selectedScreenId" class="seat-configuration">
      <h4>Seat Configuration</h4>
      
      <div class="categories-legend">
        <div *ngFor="let cat of categories()" class="category-item">
          <span class="color-box" [style.background-color]="cat.color"></span>
          <span class="category-name">{{ cat.name }}</span>
          <span class="category-price">‚Çπ{{ cat.price }}</span>
          <span class="count">({{ categoryCounts().get(cat.id) || 0 }} seats)</span>
        </div>
      </div>

      <div class="seat-stats">
        <div class="stat-item">
          <span class="stat-label">Total Seats:</span>
          <span class="stat-value">{{ totalSeats() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Available:</span>
          <span class="stat-value">{{ availableSeatsCount() }}</span>
        </div>
        <div class="stat-item">
          <span class="stat-label">Expected Revenue:</span>
          <span class="stat-value">‚Çπ{{ totalRevenue() }}</span>
        </div>
      </div>

      <div class="seat-grid-container">
        <div class="seat-grid-header">
          <p><strong>Instructions:</strong> Select a category for each row, then click seats to disable them.</p>
        </div>
        
        <div class="seat-grid">
          <div *ngFor="let rowIndex of [].constructor(rows()); let i = index; trackBy: trackByIndex" class="seat-row">
            <div class="row-label">{{ getRowLabel(i) }}</div>
            <div class="row-controls">
              <select (change)="applyCategoryToRow(i, $any($event.target).value)">
                <option value="">Select Category</option>
                <option *ngFor="let cat of categories()" [value]="cat.id">{{ cat.name }}</option>
              </select>
            </div>
            <div class="seats">
              <div *ngFor="let seat of getSeatsForRow(i)" 
                   class="seat" 
                   [style.background-color]="getSeatBackground(seat)"
                   (click)="toggleSeatDisabled(seat)"
                   [title]="seat.label + (seat.disabled ? ' (Disabled)' : '')">
                {{ seat.col + 1 }}
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <div class="form-actions">
      <button (click)="saveShow()" [disabled]="saving() || !selectedMovieId || !selectedTheaterId || !selectedScreenId || !showDateTime" class="btn-primary">
        {{ saving() ? 'Saving...' : (editingShowId() ? 'Update Show' : 'Create Show') }}
      </button>
      <button (click)="cancelForm()" [disabled]="saving()" class="btn-secondary">Cancel</button>
    </div>
  </div>
</div>
