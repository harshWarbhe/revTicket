<div class="page-wrapper">
  <!-- HEADER -->
  <header class="page-header">
    <div>
      <h1 class="page-title">Manage Screens</h1>
      <p class="page-subtitle">Manage screens and assign movies to each screen</p>
    </div>
    <button class="btn-add" (click)="addScreen()" [disabled]="loading()">
      <span>+</span>
      <span>Add Screen</span>
    </button>
  </header>

  <!-- FILTERS -->
  @if (!showForm()) {
  <section class="filters-bar">
    <div class="search-box">
      <input type="text" 
             class="search-input" 
             placeholder="Search screens..." 
             [value]="searchTerm()" 
             (input)="onSearchChange($any($event.target).value)">
      <span class="search-icon">üîç</span>
    </div>

    <select class="filter-dropdown" 
            [value]="selectedTheatre()" 
            (change)="selectedTheatre.set($any($event.target).value); onFilterChange()">
      <option value="">All Theatres</option>
      @for (theatre of theatres(); track theatre.id) {
        <option [value]="theatre.id">{{ theatre.name }}</option>
      }
    </select>

    <select class="filter-dropdown" 
            [value]="selectedStatus()" 
            (change)="selectedStatus.set($any($event.target).value); onFilterChange()">
      <option value="">All Status</option>
      <option value="ACTIVE">Active</option>
      <option value="INACTIVE">Inactive</option>
    </select>
  </section>
  }

  <!-- ADD/EDIT FORM -->
  @if (showForm()) {
  <section class="form-section">
    <div class="form-panel">
      <div class="form-header">
        <h3>{{ editingScreenId() ? 'Edit Screen' : 'Add New Screen' }}</h3>
        <button class="btn-close" (click)="cancelForm()">‚úï</button>
      </div>

      <form [formGroup]="screenForm" (ngSubmit)="submitScreen()" class="form-body">
        <div class="form-grid">
          <div class="form-field" [class.error]="isInvalid('screenNumber')">
            <label>Screen Number *</label>
            <input type="text" formControlName="screenNumber" placeholder="e.g., Screen 1, IMAX 1">
            @if (isInvalid('screenNumber')) {
              <span class="error-msg">Screen number is required</span>
            }
          </div>

          <div class="form-field" [class.error]="isInvalid('theatreId')">
            <label>Theatre *</label>
            <select formControlName="theatreId">
              <option value="">Select Theatre</option>
              @for (theatre of theatres(); track theatre.id) {
                <option [value]="theatre.id">{{ theatre.name }}</option>
              }
            </select>
            @if (isInvalid('theatreId')) {
              <span class="error-msg">Theatre is required</span>
            }
          </div>

          <div class="form-field" [class.error]="isInvalid('seatingCapacity')">
            <label>Seating Capacity *</label>
            <input type="number" formControlName="seatingCapacity" min="1" placeholder="e.g., 150">
            @if (isInvalid('seatingCapacity')) {
              <span class="error-msg">Capacity must be at least 1</span>
            }
          </div>

          <div class="form-field">
            <label>Status *</label>
            <select formControlName="status">
              <option value="ACTIVE">Active</option>
              <option value="INACTIVE">Inactive</option>
            </select>
          </div>

          <div class="form-field" [class.error]="isInvalid('rows')">
            <label>Seat Rows *</label>
            <input type="number" formControlName="rows" min="1" placeholder="e.g., 10">
            @if (isInvalid('rows')) {
              <span class="error-msg">Rows must be at least 1</span>
            }
          </div>

          <div class="form-field" [class.error]="isInvalid('columns')">
            <label>Seat Columns *</label>
            <input type="number" formControlName="columns" min="1" placeholder="e.g., 15">
            @if (isInvalid('columns')) {
              <span class="error-msg">Columns must be at least 1</span>
            }
          </div>

          <div class="form-field full">
            <label>Seat Layout Image (Optional)</label>
            <input type="file" accept="image/*" (change)="previewLayoutFile($event)">
            <input type="url" formControlName="layoutImageUrl" placeholder="Or enter image URL" (input)="layoutPreview.set($any($event.target).value)">
            @if (layoutPreview() && isImage(layoutPreview())) {
              <div class="preview-box">
                <img [src]="layoutPreview()" alt="Layout preview" class="preview-img">
              </div>
            }
          </div>
        </div>

        <div class="form-actions">
          <button type="button" class="btn-cancel" (click)="cancelForm()" [disabled]="submitting()">
            Cancel
          </button>
          <button type="submit" class="btn-save" [disabled]="screenForm.invalid || submitting()">
            {{ submitting() ? 'Saving...' : (editingScreenId() ? 'Update' : 'Add Screen') }}
          </button>
        </div>
      </form>
    </div>
  </section>
  }

  <!-- LOADING -->
  @if (loading()) {
  <section class="loading-state">
    <div class="spinner"></div>
    <p>Loading screens...</p>
  </section>
  }

  <!-- SCREENS GRID -->
  @if (!loading() && filteredScreens().length > 0 && !showForm()) {
  <section class="screens-grid">
    @for (screen of filteredScreens(); track trackById($index, screen)) {
    <div class="screen-card">
      <div class="card-header">
        <h3 class="screen-name">{{ screen.screenNumber }}</h3>
        <span class="status-pill" [class.active]="screen.status === 'ACTIVE'" [class.inactive]="screen.status === 'INACTIVE'">
          {{ screen.status }}
        </span>
      </div>
      
      <div class="card-info">
        <span class="info-tag">üè¢ {{ screen.theatre.venueName }}</span>
        <span class="divider">|</span>
        <span class="info-tag">üí∫ {{ screen.seatingCapacity }} seats</span>
      </div>
      
      <div class="card-details">
        <span class="detail-item">üìê Layout: {{ screen.seatLayout.rows }} √ó {{ screen.seatLayout.columns }}</span>
        <span class="detail-item">üé¨ {{ screen.assignedMovie ? screen.assignedMovie.title : 'No movie assigned' }}</span>
        @if (screen.showCount !== undefined) {
          <span class="detail-item">üìÖ {{ screen.showCount }} shows</span>
        }
      </div>
      
      <div class="card-actions">
        <button class="action-btn assign" (click)="assignMovie(screen)">Assign Movie</button>
        <button class="action-btn layout" (click)="openLayout(screen.id)">Layout</button>
        <button class="action-btn edit" (click)="editScreen(screen)">Edit</button>
        <button class="action-btn pause" 
                (click)="toggleStatus(screen)"
                [disabled]="statusUpdatingId() === screen.id">
          {{ statusUpdatingId() === screen.id ? 'Updating...' : (screen.status === 'ACTIVE' ? 'Pause' : 'Resume') }}
        </button>
        <button class="action-btn delete" 
                (click)="deleteScreen(screen)" 
                [disabled]="deletingId() === screen.id">
          {{ deletingId() === screen.id ? 'Deleting...' : 'Delete' }}
        </button>
      </div>
    </div>
    }
  </section>
  }

  <!-- EMPTY STATE -->
  @if (!loading() && filteredScreens().length === 0 && !showForm()) {
  <section class="empty-state">
    <div class="empty-icon">üé¨</div>
    <h3>No Screens Found</h3>
    <p>{{ searchTerm() || selectedTheatre() || selectedStatus() ? 'Try adjusting your filters' : 'Add your first screen to get started' }}</p>
    @if (!searchTerm() && !selectedTheatre() && !selectedStatus()) {
    <button class="btn-add" (click)="addScreen()">
      <span>+</span>
      <span>Add Screen</span>
    </button>
    }
  </section>
  }
</div>

<!-- ASSIGN MOVIE MODAL -->
@if (showAssignModal()) {
<div class="modal-overlay" (click)="closeAssignModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h3>Assign Movie to {{ selectedScreen()?.screenNumber }}</h3>
      <button class="btn-close" (click)="closeAssignModal()">‚úï</button>
    </div>
    <div class="modal-body">
      @if (loadingMovies()) {
        <div class="loading-state">
          <div class="spinner"></div>
          <p>Loading movies...</p>
        </div>
      } @else if (activeMovies().length === 0) {
        <p class="no-movies">No active movies available</p>
      } @else {
        <div class="movie-list">
          @for (movie of activeMovies(); track movie.id) {
            <button class="movie-item" 
                    (click)="confirmAssignMovie(movie.id)"
                    [disabled]="assigningMovie()">
              <span class="movie-title">{{ movie.title }}</span>
              <span class="movie-arrow">‚Üí</span>
            </button>
          }
        </div>
      }
    </div>
  </div>
</div>
}
